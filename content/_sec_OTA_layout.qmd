# Introduction to Layout 

Once, schematic in **Xschem** is finished, what we have is only the functional intent of the circuit. At this stage the devices are ideal: transistors have exactly the width and length we assign, wires have zero resistance, and parasitics like source/drain capacitances or coupling between metals are invisible. The layout stage is where this abstraction becomes **real silicon geometry**. Here, every transistor must be drawn in the technology’s layers, with actual fingers, source/drain contacts, guard rings and no component is ideal anymore.

For analog circuits, this step is critical. Small layout choices — for example, placing two input devices slightly asymmetrically, or routing one input longer than the other — can directly show up as offset voltage or degraded common-mode rejection. In digital design, such effects are often absorbed by logic thresholds, but in analog design they decide whether the OTA meets its simulated gain or not.

In other words, schematic defines *“what we want”*, layout decides *“what we actually get”*. This chapter focuses on showing how a *folded-cascode OTA* in **IHP-SG13G2** was translated from a verified schematic into a manufacturable layout that still respects matching, symmetry, and parasitic limits.


## Layout Toolchain: KLayout

For the layout implementation, we relied on *KLayout*. It is a free, scriptable editor that is already integrated with the **IHP-SG13G2 open-source PDK** and provided in the **IIC-OSIC toolchain**. This makes it possible to perform layout tasks without the need for commercial software.  

All necessary files — such as **Design Rule Checks (DRC)**,  **LVS comparison setups**, and **Parameterized cells (PCells)** — are directly accessible and supported within KLayout. This allows devices to be generated, verified, and extracted in a reproducible way.  

For further details, see the [KLayout website](https://www.klayout.de/).

::: {.callout-note title="Using KLayout: Docker vs. Source Build" collapse=true}

Our layout work was carried out using **KLayout v0.30.1**, provided within the **IIC-OSIC Docker image**. Since this image is a prebuilt package, some advanced KLayout or Qt features may not function as expected.  

If KLayout is build from source on your system, most of these limitations disappear, but in that case **IHP-SG13G2 technology files and libraries** must be manually integrated the into your local setup.  

For guidance on this process, a useful resource is this [Efabless tutorial (second section by Thomas Perry)](https://www.youtube.com/watch?v=CSZm3q4rUBg&list=LL&index=24&t=1181s).
:::


# Device-Level Layout Concepts

Integrated circuit layout translates the schematic into **physical layers** on silicon.  
The IHP-SG13G2 process provides numerous layers such as active/diffusion regions, poly gates, contacts, multiple metal levels, and passivation. [@IHP_PDK_2024].  
Each of these layers plays a role in forming MOSFETs, capacitors, resistors, and interconnects, further layer specific description for the IHP PDK can be found on Layout Rules [@IHP_PDK_2024].  

Unlike digital design, where the goal is mainly connectivity, analog layout must ensure **matching, symmetry, and parasitic control**. This is particularly critical in our **folded-cascode OTA**, where the differential input pair, current mirrors, and cascode devices dominate the overall gain, offset, and common-mode rejection ratio (CMRR) [@baker2010][@lienig2020].  

The following subsections describe the major device-level layout techniques used in this work, with examples and figures suggested for illustration.


## Matching & Symmetry

In real silicon, device characteristics are never perfectly uniform across the die.  
**Process gradients** arise during fabrication due to variations in temperature, pressure, and material distribution. These gradients can be visualized using concepts similar to **isobars** (lines of equal pressure) or **isotherms** (lines of equal temperature), where physical properties gradually shift across the wafer surface [@lienig2020].  

Such gradients directly affect threshold voltage, mobility, and oxide thickness. As a result, two transistors with identical schematic dimensions may behave differently if placed at different positions on the chip. For analog circuits like OTAs, these mismatches degrade input offset, gain, and common-mode rejection ratio (CMRR).  

To minimize this, layout must enforce **symmetry**:

- **Symmetry around an axis.**  
  Devices intended to operate as pairs, such as the OTA differential input transistors, are placed symmetrically about a central axis. This ensures that any linear process gradient affects both devices equally, preserving balance in their electrical behavior.  

- **Symmetry in current flow.**  
  Symmetry is not only geometrical but also electrical. The orientation of source, drain, and gate terminals is arranged so that current flows through matched devices in identical directions. This prevents systematic mismatches introduced by unequal diffusion edge proximity or channel orientation.  

Together, these forms of symmetry improve **matching** — the ability of two devices to exhibit nearly identical electrical performance. Accurate matching is critical in the OTA’s input stage, where small imbalances directly appear as input offset voltages.  

Finally, symmetry must extend to the **routing**. Interconnect lengths, widths, and via stacks must be balanced on both sides of the differential pair. Even with well-matched devices, asymmetric wiring can introduce additional resistance and capacitance, which shows up as systematic offset or degraded bandwidth [@lienig2020; @baker2010].  
In our OTA layout, routing symmetry was not only maintained in terms of path length and via balance, but also extended to the **choice of metal layers**. Long interconnects were assigned to **higher metal layers** with lower sheet resistance, while short local connections remained on **lower metals** for compact access.  
This combination of length balancing, via symmetry, and layer assignment ensured that both differential branches exhibited comparable parasitic resistance and capacitance, preserving matching despite unavoidable topological constraints.  

**Figures to include:**  
- Illustration of process gradients across a wafer .  
- Diagram comparing symmetric vs. asymmetric current flow in matched devices.


## Multi-Fingering

When MOSFETs are designed with very wide channel widths, implementing them as a single continuous device introduces several problems. A long, uninterrupted polysilicon gate line introduces significant **polysilicon gate resistance**, which degrades high-frequency behavior and increases phase delay. At the same time, the enlarged diffusion regions lead to higher source and drain junction capacitances, creating substantial loading on sensitive circuit nodes. Finally, wide monolithic devices suffer in terms of matching: process gradients across the active area are no longer averaged, making these devices more vulnerable to systematic variation and random mismatch effects [@baker2010; @lienig2020].  

The solution is **multi-fingering**: dividing the wide transistor into several narrower, identical fingers that are connected in parallel. This segmentation reduces gate resistance (shorter poly stripes), distributes junction capacitances more evenly, and improves statistical matching by averaging across multiple smaller units.  

In our OTA, the **tail current source** required a total width of 32 µm. Instead of realizing it as a single device, it was split into **eight fingers of 4 µm each**. This reduced the effective capacitance at the high-impedance tail node while keeping the layout compact and routable.  
Similarly, majority of transistors were implemented in multi-finger form to balance parasitic capacitances and maintain symmetry across branches.

Despite its benefits, multi-fingering comes with trade-offs:  
- **Increased routing overhead**, since all fingers must be tied together with well-balanced interconnect.  
- **Extra junction perimeters**, which can increase total parasitic capacitance if the layout is not compacted carefully.  
- **Via placement sensitivity**, as each finger requires source/drain contacts and vias; poor via distribution can lead to resistance mismatches or electromigration concerns.  

For this reason, multi-fingering is often combined with other layout strategies.  
**Dummies** are placed at the array edges to shield active fingers, while **common-centroid arrangements** may be used for further gradient cancellation. This combined approach was applied in our OTA’s diffpair, ensuring both parasitic reduction and high matching fidelity.

**Figures to include:**  
- Comparison of a single wide MOSFET vs. multi-finger implementation (adapted from @baker2010, Ch. 5).  
- Annotated OTA tail transistor layout showing finger distribution.  

**Also, add note here refering to the sub topic how to calculate minimum number of fingers later on**


## Dummy Devices

Even when multi-fingering is used, the **edge fingers** of a device array experience different fabrication conditions compared to the inner fingers. At the boundary between active diffusion and isolation (STI), variations in oxide growth, stress, and implant profiles create **edge effects** that change threshold voltage, carrier mobility, and junction capacitance [@baker2010].  
If left unaddressed, these systematic differences degrade device matching, particularly in sensitive analog structures such as the OTA input pair or current mirrors.  

To eliminate this, **dummy devices** are placed at the ends of transistor arrays. They act as sacrificial neighbors, ensuring that all *active* devices are surrounded by identical environments.  
This makes the inner devices more uniform, effectively shielding them from edge-related mismatches.  

Connection of dummy devices can vary across design flows:  
- In some methodologies, dummy gates are left **floating**, since their only role is geometric.  
- In others, dummies are **tied to supply rails** (AVDD or AVSS) to avoid LVS errors and ensure consistent recognition by verification tools.  

In our OTA, Dummy devices were placed at the edges of all the MOSFET's. This ensured that all transistors within the OTA operated in well-matched environments, minimizing systematic offset.

**Figures to include:**  
- Annotated OTA differential input pair layout highlighting dummy devices.  
- LVS schematic vs. layout comparison demonstrating explicit dummy recognition.  


::: {.callout-important title="Important Implementation Note" collapse=true} 

In our OTA layout, dummy devices were implemented as **complete MOSFETs** with their gates explicitly tied to **AVDD** or **AVSS**.  
This was necessary because in **KLayout**, adding an extra finger with an unconnected gate is not recognized as a dummy. LVS then fails due to netlist mismatches.  

To ensure **LVS clean results**, we:  
- Added dummy devices explicitly in the schematic.  
- Connected all terminals to valid nets.  
- Replicated the same connections in layout.  
:::


## Interdigitated Layout

When two matched transistors are placed adjacent to each other but in separate diffusion regions, each device is exposed to a slightly different portion of the process gradient across the chip. As a result, parameters such as threshold voltage, carrier mobility, and oxide thickness vary between them, leading to a systematic mismatch even though both devices have identical drawn dimensions.  

The **interdigitated layout technique** addresses this issue by physically alternating the unit devices of a matched pair or array. Instead of grouping devices as AA–BB, the transistors are arranged in an alternating or mirrored pattern such as **ABAB** or **A–B–B–A**, where *A* and *B* represent identical unit devices belonging to two matched elements.  
Through this alternating placement, each device is spatially distributed across the gradient, allowing it to experience regions of both higher and lower process variations. As a result, the local fabrication differences are **averaged** out across all unit fingers, and the two devices become physically and electrically better matched under real process conditions.

This concept can be visualized by imagining a linear gradient across the x-axis of the die. If one device occupies the left region and the other the right, they sample distinct gradient values. However, when their unit fingers are interleaved, each device occupies multiple local regions along the gradient, resulting in matched *average parameters*.


In practice, interdigitation is most effective for **linear process gradients** along one direction and is often used for **matched transistor pairs, current mirrors, or differential input stages**.  
For two-dimensional gradients or more complex variations, this technique is typically extended using **common-centroid placement** (discussed in the next section).

In the folded-cascode OTA, **interdigitation** was applied to the active loads and bias current mirrors. This layout ensured that each mirrored transistor experienced an equivalent average doping and oxide thickness, resulting in better current matching, symmetrical output swing, and reduced systematic offset in bias generation.

**Figures to include:**  
- Stick diagram of ABBA and A–B–B–A patterns   
- Simplified OTA layout snippet showing interdigitated differential pair.  


## Common-Centroid Layout

While interdigitation cancels **first-order linear gradients** along a single direction, it cannot fully correct for **two-dimensional or higher-order variations** such as diagonal gradients or wafer-level curvature. For more advanced matching requirements—such as in precision current mirrors or differential pairs in high-gain OTAs—the **common-centroid layout** is used.

In a common-centroid configuration, matched devices are arranged so that their geometric centers, or **centroids**, coincide. Each device is distributed symmetrically around a central point such that any gradient—whether horizontal, vertical, or diagonal—affects both devices equally when averaged over their area. This approach effectively cancels first-order gradient components in both axes and reduces second-order effects as well [@lienig2020].

Conceptually, the centroid layout extends the interdigitated approach into two dimensions. For example, four identical transistors can be arranged symmetrically around a central point in an ABBA pattern, forming what is effectively a square or cross-shaped configuration.
Although each individual finger occupies a slightly different position on the chip—and therefore a slightly different local environment—the geometric center (centroid) of all devices coincides. This ensures that the averaged electrical properties of each device are identical, effectively cancelling first-order process gradients across both axes.

In our folded-cascode OTA, the **diff pair** were laid out using a **common-centroid pattern** derived from the ABBA principle. This was essential to maintain current accuracy and minimize systematic gain variation.  
The layout ensured that matched transistors experienced a balanced environment, even in the presence of lateral thermal gradients or stress gradients from nearby metal density variations.

**Routing Considerations:**  
As with other symmetry-based techniques, routing must be performed with identical path lengths, metal layers, and via distributions.  
Any asymmetry in interconnect can reintroduce mismatch.  
In our OTA, gate and drain connections were mirrored geometrically, using identical layer transitions and via stacks.  
Where routing overlap was unavoidable, orthogonal layer separation was employed to maintain isolation and prevent parasitic imbalance.

**Figures to include:**  
- Common-centroid ABBA layout pattern illustration.  
- Annotated OTA current mirror layout highlighting centroid alignment.  
- Comparative figure: linear vs. 2D gradient compensation.


## Finger Count Estimation (Minimum Number of Fingers)

This section presents a procedural method to estimate the **minimum number of fingers** \(N_f\) for a wide MOSFET such that  
(i) the **gate resistance** remains within target limits, and  
(ii) the **junction capacitance** growth stays acceptable.  
The approach follows the standard treatment of **distributed gate resistance** and **junction-capacitance scaling** as described in classical analog IC design (book by Prof. Razavi).


### Problem Setup

Given a device with total drawn width \(W_tot\) and channel length \(L\), we split it into \(N_f\) identical fingers of width

$$
W_f = \frac{W_{\text{tot}}}{N_f}.
$$

We impose two considerations:

1. **Gate-resistance**  
   $$
   R_g(N_f) \le R_{g,\text{max}}
   $$
   where \(R_{g,\text{max}}\) is derived from the bandwidth or phase-margin budget  
   (e.g., \(R_g C_{\text{gate}} \ll 1/\omega_{\text{UGB}}\)).

2. **Junction-capacitance**  
   $$
   C_{j,\text{sw}}(N_f) \le C_{\text{par},\text{max}}
   $$
   where \(C_{\text{par},\text{max}}\) is the allowable parasitic capacitance at that node.

The **minimum feasible number of fingers** is the smallest integer \(N_f\) that satisfies both conditions.


### Gate Resistance Model

For a multi-finger MOSFET, the gate behaves as a distributed RC network.  
With **double-ended gate contacts**, the effective gate resistance per finger is approximated as:

$$
R_{g,\text{per-finger}} \approx \kappa \frac{R_{\text{sh,g}} L}{W_f},
$$

where:

- \(R_{\text{sh,g}}\) — gate (poly) sheet resistance  
- \(L\) — channel length  
- \(W_f\) — finger width  
- \(\kappa\) — contact geometry factor (≈ 1/3 for double-ended gates)

Since the \(N_f\) fingers are connected in parallel at the gate:

$$
R_g(N_f) \approx \frac{R_{g,\text{per-finger}}}{N_f}
= \frac{\kappa R_{\text{sh,g}} L}{W_f N_f}
= \frac{\kappa R_{\text{sh,g}} L}{(W_{\text{tot}}/N_f) N_f}
= \frac{\kappa R_{\text{sh,g}} L}{W_{\text{tot}}}.
$$

> **Note:**  
> With ideal double-ended contacts, \(R_g\) becomes nearly **independent of \(N_f\)**.  
> In practice, non-ideal feed resistance and layout effects introduce a weak dependence.

The design condition becomes:

$$
R_g \le R_{g,\text{max}} \quad \Rightarrow \quad
\frac{\kappa R_{\text{sh,g}} L}{W_{\text{tot}}} \le R_{g,\text{max}}.
$$


### Junction Capacitance Model

For one finger, the junction capacitance can be expressed as:

$$
C_{j,\text{finger}} \approx C_{j0} A_f + C_{j,\text{sw0}} P_f,
$$

where:

- \(C_{j0}\) — area capacitance per unit area  
- \(C_{j,\text{sw0}}\) — sidewall capacitance per unit length  
- \(A_f \approx W_f L_{\text{diff}}\) — diffusion area  
- \(P_f \approx 2 (W_f + L_{\text{diff}})\) — diffusion perimeter  
- \(L_{\text{diff}}\) — effective diffusion length

For \(N_f\) identical fingers:

$$
\begin{aligned}
C_{j,\text{total}}(N_f)
&= N_f (C_{j0} A_f + C_{j,\text{sw0}} P_f) \\
&\approx N_f \big(C_{j0} W_f L_{\text{diff}} + 2 C_{j,\text{sw0}} (W_f + L_{\text{diff}})\big).
\end{aligned}
$$

Substituting \(W_f = W_{\text{tot}}/N_f\):

$$
C_{j,\text{total}}(N_f)
\approx
C_{j0} W_{\text{tot}} L_{\text{diff}}
+ 2 C_{j,\text{sw0}} W_{\text{tot}}
+ 2 C_{j,\text{sw0}} N_f L_{\text{diff}}.
$$

- The **area term** is independent of \(N_f\).  
- The **sidewall term** increases linearly with \(N_f\).

To keep junction parasitics within budget:

$$
C_{j,\text{total}}(N_f) \le C_{\text{par},\text{max}}
\Rightarrow
N_f \le
\frac{
C_{\text{par},\text{max}}
- (C_{j0} W_{\text{tot}} L_{\text{diff}} + 2 C_{j,\text{sw0}} W_{\text{tot}})
}{
2 C_{j,\text{sw0}} L_{\text{diff}}
}.
$$

Round down to the nearest integer to obtain \(N_{f,\text{max}}^{(C)}\).


### Selection Procedure

1. **Inputs:**  
   \(W_{\text{tot}}, L, R_{\text{sh,g}}, C_{j0}, C_{j,\text{sw0}}, L_{\text{diff}}, C_{\text{par},\text{max}}, R_{g,\text{max}}\).

2. **Gate resistance check:**  
   Compute \(R_g = \dfrac{\kappa R_{\text{sh,g}} L}{W_{\text{tot}}}\).  
   - If \(R_g \le R_{g,\text{max}}\): acceptable.  
   - Otherwise: increase \(W_{\text{tot}}\) or use double-ended gate contacts.

3. **Sidewall capacitance limit:**  
   Evaluate \(N_{f,\text{max}}^{(C)}\) from the inequality above.

4. **Layout practical bound:**  
   Define a minimum practical finger width (\(W_f\) ≈ 2–5 µm, depending on design rules).  
   Include requirements for **interdigitation**, **dummies**, and **via redundancy** to determine \(N_{f,\text{min}}^{(\text{layout})}\).

5. **Choose final \(N_f\):**

$$
N_f = \max(N_{f,\text{min}}^{(\text{layout})})
\quad \text{subject to} \quad
N_f \le N_{f,\text{max}}^{(C)}.
$$

If no solution satisfies both, adjust \(C_{\text{par},\text{max}}\) or device dimensions.


### Example (OTA Tail Transistor)

Given:  
\(W_{\text{tot}} = 32\,\mu\text{m}\), \(L = 0.13\,\mu\text{m}\), and process parameters from the SG13G2 PDK.  
For \(C_{\text{par},\text{max}}\) derived from node bandwidth and \(R_{g,\text{max}}\) from gain-phase margin analysis,  
the calculated range of feasible finger counts typically lies between **6 and 10**.  
A choice of **8 fingers** provided the optimal trade-off between parasitics, matching, and layout density.

**Figures to include:**  
- Plot of \(C_{j,\text{total}}(N_f)\): constant area term vs. linear sidewall growth.  
- Gate contact scheme: single-ended vs. double-ended.  
- Annotated MOS layout showing definitions of \(W_f\), \(L_{\text{diff}}\), and perimeter components.

> **Note:**  
> Ensure that the chosen \(N_f\) aligns with the dummy-device strategy (explicit schematic inclusion)  
> and supports interdigitated or centroided patterns used for matching.  
> This guarantees LVS-clean results and consistent parasitic extraction.


::: {.callout-note title="Number of fingers Calculation using Python Script" collapse="true"}
{{< embed ../layout_scripts/min_fingers_calculation.ipynb# echo=true >}}
:::

