# Introduction to Layout 

Once, schematic in **Xschem** is finished, what we have is only the functional intent of the circuit. At this stage the devices are ideal: transistors have exactly the width and length we assign, wires have zero resistance, and parasitics like source/drain capacitances or coupling between metals are invisible. The layout stage is where this abstraction becomes **real silicon geometry**. Here, every transistor must be drawn in the technology’s layers, with actual fingers, source/drain contacts, guard rings and no component is ideal anymore.

For analog circuits, this step is critical. Small layout choices — for example, placing two input devices slightly asymmetrically, or routing one input longer than the other — can directly show up as offset voltage or degraded common-mode rejection. In digital design, such effects are often absorbed by logic thresholds, but in analog design they decide whether the OTA meets its simulated gain or not.

In other words, schematic defines *“what we want”*, layout decides *“what we actually get”*. This chapter focuses on showing how a *folded-cascode OTA* in **IHP-SG13G2** was translated from a verified schematic into a manufacturable layout that still respects matching, symmetry, and parasitic limits.


## Layout Toolchain: KLayout

For the layout implementation, we relied on *KLayout*. It is a free, scriptable editor that is already integrated with the **IHP-SG13G2 open-source PDK** and provided in the **IIC-OSIC toolchain**. This makes it possible to perform layout tasks without the need for commercial software.  

All necessary files — such as **Design Rule Checks (DRC)**,  **LVS comparison setups**, and **Parameterized cells (PCells)** — are directly accessible and supported within KLayout. This allows devices to be generated, verified, and extracted in a reproducible way.  

For further details, see the [KLayout website](https://www.klayout.de/).

::: {.callout-note title="Using KLayout: Docker vs. Source Build" collapse=true}

Our layout work was carried out using **KLayout v0.30.1**, provided within the **IIC-OSIC Docker image**. Since this image is a prebuilt package, some advanced KLayout or Qt features may not function as expected.  

If KLayout is build from source on your system, most of these limitations disappear, but in that case **IHP-SG13G2 technology files and libraries** must be manually integrated the into your local setup.  

For guidance on this process, a useful resource is this [Efabless tutorial (second section by Thomas Perry)](https://www.youtube.com/watch?v=CSZm3q4rUBg&list=LL&index=24&t=1181s).
:::

# Device-Level Layout Concepts

Integrated circuit layout translates the schematic into **physical layers** on silicon.  
The IHP-SG13G2 process provides numerous layers such as active/diffusion regions, poly gates, contacts, multiple metal levels, and passivation. [@IHP_PDK_2024].  
Each of these layers plays a role in forming MOSFETs, capacitors, resistors, and interconnects, further layer specific description for the IHP PDK can be found on Layout Rules [@IHP_PDK_2024].  

Unlike digital design, where the goal is mainly connectivity, analog layout must ensure **matching, symmetry, and parasitic control**. This is particularly critical in our **folded-cascode OTA**, where the differential input pair, current mirrors, and cascode devices dominate the overall gain, offset, and common-mode rejection ratio (CMRR) [@baker2010][@lienig2020].  

The following subsections describe the major device-level layout techniques used in this work, with examples and figures suggested for illustration.

---

## 1. Matching & Symmetry

In real silicon, device characteristics are never perfectly uniform across the die.  
**Process gradients** arise during fabrication due to variations in temperature, pressure, and material distribution. These gradients can be visualized using concepts similar to **isobars** (lines of equal pressure) or **isotherms** (lines of equal temperature), where physical properties gradually shift across the wafer surface [@lienig2020].  

Such gradients directly affect threshold voltage, mobility, and oxide thickness. As a result, two transistors with identical schematic dimensions may behave differently if placed at different positions on the chip. For analog circuits like OTAs, these mismatches degrade input offset, gain, and common-mode rejection ratio (CMRR).  

To minimize this, layout must enforce **symmetry**:

- **Symmetry around an axis.**  
  Devices intended to operate as pairs, such as the OTA differential input transistors, are placed symmetrically about a central axis. This ensures that any linear process gradient affects both devices equally, preserving balance in their electrical behavior.  

- **Symmetry in current flow.**  
  Symmetry is not only geometrical but also electrical. The orientation of source, drain, and gate terminals is arranged so that current flows through matched devices in identical directions. This prevents systematic mismatches introduced by unequal diffusion edge proximity or channel orientation.  

Together, these forms of symmetry improve **matching** — the ability of two devices to exhibit nearly identical electrical performance. Accurate matching is critical in the OTA’s input stage, where small imbalances directly appear as input offset voltages.  

Finally, symmetry must extend to the **routing**. Interconnect lengths, widths, and via stacks must be balanced on both sides of the differential pair. Even with well-matched devices, asymmetric wiring can introduce additional resistance and capacitance, which shows up as systematic offset or degraded bandwidth [@lienig2020; @baker2010].  
In our OTA layout, routing symmetry was not only maintained in terms of path length and via balance, but also extended to the **choice of metal layers**. Long interconnects were assigned to **higher metal layers** with lower sheet resistance, while short local connections remained on **lower metals** for compact access.  
This combination of length balancing, via symmetry, and layer assignment ensured that both differential branches exhibited comparable parasitic resistance and capacitance, preserving matching despite unavoidable topological constraints.  


## 2. Multi-Fingering

When MOSFETs are designed with very wide channel widths, implementing them as a single continuous device introduces several problems. A long, uninterrupted polysilicon gate line introduces significant **polysilicon gate resistance**, which degrades high-frequency behavior and increases phase delay. At the same time, the enlarged diffusion regions lead to higher source and drain junction capacitances, creating substantial loading on sensitive circuit nodes. Finally, wide monolithic devices suffer in terms of matching: process gradients across the active area are no longer averaged, making these devices more vulnerable to systematic variation and random mismatch effects [@baker2010; @lienig2020].  

The solution is **multi-fingering**: dividing the wide transistor into several narrower, identical fingers that are connected in parallel. This segmentation reduces gate resistance (shorter poly stripes), distributes junction capacitances more evenly, and improves statistical matching by averaging across multiple smaller units.  

In our OTA, the **tail current source** required a total width of 32 µm. Instead of realizing it as a single device, it was split into **eight fingers of 4 µm each**. This reduced the effective capacitance at the high-impedance tail node while keeping the layout compact and routable.  
Similarly, majority of transistors were implemented in multi-finger form to balance parasitic capacitances and maintain symmetry across branches.

Despite its benefits, multi-fingering comes with trade-offs:  
- **Increased routing overhead**, since all fingers must be tied together with well-balanced interconnect.  
- **Extra junction perimeters**, which can increase total parasitic capacitance if the layout is not compacted carefully.  
- **Via placement sensitivity**, as each finger requires source/drain contacts and vias; poor via distribution can lead to resistance mismatches or electromigration concerns.  

For this reason, multi-fingering is often combined with other layout strategies.  
**Dummies** are placed at the array edges to shield active fingers, while **common-centroid arrangements** may be used for further gradient cancellation. This combined approach was applied in our OTA’s diffpair, ensuring both parasitic reduction and high matching fidelity.

**Figures to include:**  
- Comparison of a single wide MOSFET vs. multi-finger implementation (adapted from @baker2010, Ch. 5).  
- Annotated OTA tail transistor layout showing finger distribution.  

**Also, add note here refering to the sub topic how to calculate minimum number of fingers later on**

---

## 3. Dummy Devices

Even when multi-fingering is used, the **edge fingers** of a device array experience different fabrication conditions compared to the inner fingers. At the boundary between active diffusion and isolation (STI), variations in oxide growth, stress, and implant profiles create **edge effects** that change threshold voltage, carrier mobility, and junction capacitance [@baker2010].  
If left unaddressed, these systematic differences degrade device matching, particularly in sensitive analog structures such as the OTA input pair or current mirrors.  

To eliminate this, **dummy devices** are placed at the ends of transistor arrays. They act as sacrificial neighbors, ensuring that all *active* devices are surrounded by identical environments.  
This makes the inner devices more uniform, effectively shielding them from edge-related mismatches.  

Connection of dummy devices can vary across design flows:  
- In some methodologies, dummy gates are left **floating**, since their only role is geometric.  
- In others, dummies are **tied to supply rails** (AVDD or AVSS) to avoid LVS errors and ensure consistent recognition by verification tools.  

**OTA application:**  
Dummy devices were placed at the edges of the differential input pair and at the current mirror arrays.  
This ensured that all active transistors within the OTA operated in well-matched environments, minimizing systematic offset.

**Figures to include:**  
- Annotated OTA differential input pair layout highlighting dummy devices.  
- LVS schematic vs. layout comparison demonstrating explicit dummy recognition.  


**Figures to include:**  
- Illustration of process gradients across a wafer (adapted from @lienig2020).  
  
- Diagram comparing symmetric vs. asymmetric current flow in matched devices.  
- Example of routing balance in the differential pair (adapted from @baker2010, Ch. 22 *Differential Amplifiers*).  


---



::: callout-note
## Important Implementation Note  

In our OTA layout, dummy devices were implemented as **complete MOSFETs** with their gates explicitly tied to **AVDD** or **AVSS**.  

This was necessary because in **KLayout**, adding an extra finger with an unconnected gate is not recognized as a dummy.  
LVS then fails due to netlist mismatches.  

To ensure **LVS clean results**, we:  
- Added dummy devices explicitly in the schematic.  
- Connected their gates to valid nets (AVDD/AVSS).  
- Replicated the same connections in layout.  
:::



Add more details here
