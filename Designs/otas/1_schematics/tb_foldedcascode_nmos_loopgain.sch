v {xschem version=3.4.7 file_version=1.2}
G {}
K {}
V {}
S {}
E {}
P 4 5 1110 -540 2530 -540 2530 -40 1110 -40 1110 -540 {dash = 4}
P 4 5 1110 -1100 2530 -1100 2530 -600 1110 -600 1110 -1100 {dash = 4}
T {Middlebrook's Method} 1110 -570 0 0 0.4 0.4 {}
T {Tian's Method} 1110 -1130 0 0 0.4 0.4 {}
N 790 -80 790 -60 {
lab=GND}
N 950 -80 950 -60 {
lab=GND}
N 1570 -320 1650 -320 {
lab=vr1}
N 1450 -500 1450 -480 {lab=v_dd}
N 1450 -420 1450 -400 {lab=#net1}
N 1170 -290 1330 -290 {lab=vf1}
N 1170 -290 1170 -200 {lab=vf1}
N 790 -160 790 -140 {lab=v_dd}
N 950 -160 950 -140 {lab=v_ss}
N 790 -240 790 -220 {lab=v_ss}
N 790 -320 790 -300 {lab=v_in}
N 1650 -320 1650 -260 {lab=vr1}
N 1650 -200 1650 -140 {lab=v_ss}
N 1570 -320 1570 -200 {lab=vr1}
N 1170 -350 1330 -350 {lab=v_in}
N 1310 -200 1570 -200 {lab=vr1}
N 1170 -200 1250 -200 {lab=vf1}
N 2330 -320 2410 -320 {
lab=#net2}
N 2210 -500 2210 -480 {lab=v_dd}
N 2210 -420 2210 -400 {lab=#net3}
N 1930 -290 2090 -290 {lab=#net4}
N 1930 -290 1930 -200 {lab=#net4}
N 2410 -320 2410 -260 {lab=#net2}
N 2410 -200 2410 -140 {lab=v_ss}
N 2170 -140 2410 -140 {lab=v_ss}
N 2330 -320 2330 -200 {lab=#net2}
N 1930 -350 2090 -350 {lab=v_in}
N 2050 -200 2070 -200 {
lab=#net5}
N 2170 -140 2170 -80 {lab=v_ss}
N 2050 -200 2050 -160 {lab=#net5}
N 2030 -200 2050 -200 {
lab=#net5}
N 2130 -200 2330 -200 {lab=#net2}
N 1930 -200 1970 -200 {lab=#net4}
N 2050 -100 2050 -80 {lab=v_ss}
N 2050 -80 2170 -80 {lab=v_ss}
N 1570 -880 1650 -880 {
lab=#net6}
N 1450 -1060 1450 -1040 {lab=v_dd}
N 1450 -980 1450 -960 {lab=#net7}
N 1170 -850 1330 -850 {lab=vmeas1}
N 1650 -880 1650 -820 {lab=#net6}
N 1650 -760 1650 -700 {lab=v_ss}
N 1410 -700 1650 -700 {lab=v_ss}
N 1570 -880 1570 -760 {lab=#net6}
N 1170 -910 1330 -910 {lab=v_in}
N 2330 -880 2410 -880 {
lab=#net8}
N 2210 -1060 2210 -1040 {lab=v_dd}
N 2210 -980 2210 -960 {lab=#net9}
N 1930 -850 2090 -850 {lab=vmeas2}
N 1930 -850 1930 -760 {lab=vmeas2}
N 2410 -880 2410 -820 {lab=#net8}
N 2410 -760 2410 -700 {lab=v_ss}
N 2170 -700 2410 -700 {lab=v_ss}
N 2330 -880 2330 -760 {lab=#net8}
N 1930 -910 2090 -910 {lab=v_in}
N 2170 -700 2170 -620 {lab=v_ss}
N 2130 -760 2330 -760 {lab=#net8}
N 1170 -650 1170 -620 {lab=v_ss}
N 1270 -760 1310 -760 {lab=#net10}
N 1370 -760 1570 -760 {lab=#net6}
N 1170 -760 1210 -760 {lab=vmeas1}
N 1170 -850 1170 -760 {lab=vmeas1}
N 1170 -720 1210 -720 {lab=vmeas1}
N 1170 -760 1170 -720 {lab=vmeas1}
N 1170 -720 1170 -700 {lab=vmeas1}
N 1170 -620 1410 -620 {lab=v_ss}
N 1410 -700 1410 -620 {lab=v_ss}
N 2030 -760 2070 -760 {lab=#net11}
N 1930 -760 1970 -760 {lab=vmeas2}
N 1930 -640 1930 -620 {lab=v_ss}
N 1930 -620 2170 -620 {lab=v_ss}
N 1930 -720 1930 -700 {lab=vmeas2}
N 1930 -720 1970 -720 {lab=vmeas2}
N 1930 -760 1930 -720 {lab=vmeas2}
N 1500 -880 1570 -880 {lab=#net6}
N 1280 -880 1330 -880 {lab=#net7}
N 1280 -960 1280 -880 {lab=#net7}
N 1280 -960 1450 -960 {lab=#net7}
N 2260 -880 2330 -880 {lab=#net8}
N 2040 -880 2090 -880 {lab=#net9}
N 2040 -960 2040 -880 {lab=#net9}
N 2040 -960 2210 -960 {lab=#net9}
N 2040 -320 2090 -320 {lab=#net3}
N 2040 -400 2040 -320 {lab=#net3}
N 2040 -400 2210 -400 {lab=#net3}
N 1280 -320 1330 -320 {lab=#net1}
N 1280 -400 1280 -320 {lab=#net1}
N 1280 -400 1450 -400 {lab=#net1}
N 1500 -320 1570 -320 {lab=vr1}
N 2260 -320 2330 -320 {lab=#net2}
N 950 -240 950 -220 {lab=v_ss}
N 950 -320 950 -300 {lab=v_ena}
N 1380 -1060 1380 -950 {lab=v_dd}
N 1380 -1060 1450 -1060 {lab=v_dd}
N 1380 -810 1380 -700 {lab=v_ss}
N 1380 -700 1410 -700 {lab=v_ss}
N 2140 -810 2140 -700 {lab=v_ss}
N 2140 -700 2170 -700 {lab=v_ss}
N 2140 -1060 2140 -950 {lab=v_dd}
N 2140 -1060 2210 -1060 {lab=v_dd}
N 1380 -500 1380 -390 {lab=v_dd}
N 1380 -500 1450 -500 {lab=v_dd}
N 1380 -250 1380 -140 {lab=v_ss}
N 1380 -140 1650 -140 {lab=v_ss}
N 2140 -250 2140 -140 {lab=v_ss}
N 2140 -140 2170 -140 {lab=v_ss}
N 2140 -500 2140 -390 {lab=v_dd}
N 2140 -500 2210 -500 {lab=v_dd}
C {devices/code_shown.sym} 70 -100 0 0 {name=MODEL only_toplevel=true
format="tcleval( @value )"
value="
.lib cornerMOSlv.lib mos_tt
.lib cornerRES.lib res_typ
"}
C {devices/vsource.sym} 790 -110 0 0 {name=Vdd value=1.5}
C {devices/gnd.sym} 790 -60 0 0 {name=l3 lab=GND}
C {devices/lab_pin.sym} 790 -160 0 0 {name=p2 sig_type=std_logic lab=v_dd}
C {devices/vsource.sym} 950 -110 0 0 {name=Vss value=0}
C {devices/gnd.sym} 950 -60 0 0 {name=l1 lab=GND}
C {devices/lab_pin.sym} 950 -160 0 0 {name=p1 sig_type=std_logic lab=v_ss}
C {devices/vsource.sym} 790 -270 0 0 {name=Vin value="dc 0.75"}
C {devices/lab_wire.sym} 790 -320 0 0 {name=p4 sig_type=std_logic lab=v_in}
C {devices/lab_pin.sym} 1380 -500 0 0 {name=p5 sig_type=std_logic lab=v_dd}
C {devices/lab_pin.sym} 1410 -140 0 0 {name=p6 sig_type=std_logic lab=v_ss}
C {devices/capa.sym} 1650 -230 0 0 {name=C2
value=2p}
C {devices/lab_wire.sym} 1170 -350 0 0 {name=p9 sig_type=std_logic lab=v_in}
C {devices/isource.sym} 1450 -450 0 0 {name=I1 value=40u pwl(0 0 10u 0 11u 40u)"}
C {devices/lab_pin.sym} 790 -220 0 0 {name=p11 sig_type=std_logic lab=v_ss}
C {devices/vsource.sym} 1280 -200 3 0 {name=Vtest1 value="dc 0 ac 1"}
C {devices/lab_wire.sym} 1210 -200 0 0 {name=p3 sig_type=std_logic lab=vf1}
C {devices/lab_wire.sym} 1360 -200 0 0 {name=p13 sig_type=std_logic lab=vr1}
C {devices/lab_pin.sym} 2140 -500 0 0 {name=p14 sig_type=std_logic lab=v_dd}
C {devices/lab_pin.sym} 2170 -140 0 0 {name=p15 sig_type=std_logic lab=v_ss}
C {devices/capa.sym} 2410 -230 0 0 {name=C1
value=2p}
C {devices/lab_wire.sym} 1930 -350 0 0 {name=p17 sig_type=std_logic lab=v_in}
C {devices/isource.sym} 2210 -450 0 0 {name=I2 value=40u pwl(0 0 10u 0 11u 40u)"}
C {devices/ammeter.sym} 2100 -200 1 0 {name=Vir1 savecurrent=true spice_ignore=0}
C {devices/ammeter.sym} 2000 -200 1 0 {name=Vif1 savecurrent=true spice_ignore=0}
C {devices/isource.sym} 2050 -130 2 0 {name=Itest1 value="dc 0 ac 1"}
C {devices/lab_pin.sym} 1380 -1060 0 0 {name=p19 sig_type=std_logic lab=v_dd}
C {devices/lab_pin.sym} 1410 -700 0 0 {name=p20 sig_type=std_logic lab=v_ss}
C {devices/capa.sym} 1650 -790 0 0 {name=C3
value=2p}
C {devices/lab_wire.sym} 1170 -910 0 0 {name=p22 sig_type=std_logic lab=v_in}
C {devices/isource.sym} 1450 -1010 0 0 {name=I3 value=40u pwl(0 0 10u 0 11u 40u)"}
C {devices/lab_pin.sym} 2140 -1060 0 0 {name=p26 sig_type=std_logic lab=v_dd}
C {devices/lab_pin.sym} 2170 -700 0 0 {name=p27 sig_type=std_logic lab=v_ss}
C {devices/capa.sym} 2410 -790 0 0 {name=C4
value=2p}
C {devices/lab_wire.sym} 1930 -910 0 0 {name=p29 sig_type=std_logic lab=v_in}
C {devices/isource.sym} 2210 -1010 0 0 {name=I4 value=40u pwl(0 0 10u 0 11u 40u)"}
C {devices/isource.sym} 1170 -670 2 1 {name=Itest3 value="dc 0 ac 0"}
C {devices/vsource.sym} 1240 -760 3 0 {name=Vtest2 value="dc 0 ac 1"}
C {devices/lab_wire.sym} 1210 -720 2 0 {name=p24 sig_type=std_logic lab=vmeas1}
C {devices/ammeter.sym} 1340 -760 1 0 {name=Vimeas1 savecurrent=true spice_ignore=0}
C {devices/isource.sym} 1930 -670 2 1 {name=Itest2 value="dc 0 ac 1"}
C {devices/vsource.sym} 2000 -760 3 0 {name=Vtest3 value="dc 0 ac 0"}
C {devices/lab_wire.sym} 1970 -720 2 0 {name=p25 sig_type=std_logic lab=vmeas2}
C {devices/ammeter.sym} 2100 -760 1 0 {name=Vimeas2 savecurrent=true spice_ignore=0}
C {foldedcascode_nmos.sym} 1480 -880 0 0 {name=x3}
C {foldedcascode_nmos.sym} 2240 -880 0 0 {name=x4}
C {foldedcascode_nmos.sym} 1480 -320 0 0 {name=x1}
C {foldedcascode_nmos.sym} 2240 -320 0 0 {name=x2}
C {devices/title.sym} 210 80 0 0 {name=l5 author="(c) 2025 Thesis_HP, Apache-2.0 license"}
C {devices/vsource.sym} 950 -270 0 0 {name=Venable value=1.5 savecurrent=false}
C {devices/lab_wire.sym} 950 -320 0 1 {name=p8 sig_type=std_logic lab=v_ena}
C {devices/lab_pin.sym} 950 -220 0 0 {name=p12 sig_type=std_logic lab=v_ss}
C {devices/lab_wire.sym} 1420 -820 2 0 {name=p23 sig_type=std_logic lab=v_ena}
C {devices/lab_wire.sym} 2180 -820 2 0 {name=p7 sig_type=std_logic lab=v_ena}
C {devices/lab_wire.sym} 1420 -260 1 1 {name=p10 sig_type=std_logic lab=v_ena}
C {devices/lab_wire.sym} 2180 -260 1 1 {name=p16 sig_type=std_logic lab=v_ena}
C {devices/code_shown.sym} 60 -1230 0 0 {name=NGSPICE1
only_toplevel=true
value="

*.include /foss/designs/thesis/thesis_hp/designs/otas/3_kpex/foldedcascode_nmos_withdummies__foldedcascode_nmos_withdummies/magic_CC/foldedcascode_nmos_withdummies.pex.spice


.param temp=27
.options savecurrents reltol=1e-3 abstol=1e-12 gmin=1e-15
.control
save all

* Operating Point Analysis
op

* AC Analysis
ac dec 101 1 100G
remzerovec

* Middlebrook's Method
let tv  = -v(vr1)/v(vf1)
let ti  = -i(vir1)/i(vif1)
let tmb = (tv*ti - 1)/(tv + ti + 2)

* Tian's Method
* vtest=0, itest=1:
let A = i(Vimeas2)
let C = v(vmeas2)

* vtest=1, itest=0:
let B = i(Vimeas1)
let D = v(vmeas1)
let ttian = (A*D - B*C - A)/(2*(B*C - A*D) + A - D + 1)

* optional interactive plots
* plot db(tmb) ylabel 'Magnitude - Middlebrook'
* plot 180/pi*cphase(tmb) ylabel 'Phase - Middlebrook'
* plot db(ttian) ylabel 'Magnitude - Tian'
* plot 180/pi*cphase(ttian) ylabel 'Phase - Tian'
*plot db(tmb) db(ttian) ylabel 'Magnitude'
*plot 180/pi*cphase(tmb) 180/pi*cphase(ttian) ylabel 'Phase'

* SINGLE clean write at the end
write foldedcascode_nmos_tb-loopgain.raw

.endc
"}
